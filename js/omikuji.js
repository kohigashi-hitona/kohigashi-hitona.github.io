const omikuji_text = [
    {
        "good-luck": 10,
        "content-cn": "曾经的努力和经验会成为他人眼中魅力的样子",
        "content-jp": "昔の努力と経験は他の人の目に魅力的になります"
    },
    {
        "good-luck": 24,
        "content-cn": "财运顺畅，临时收入也可期待"
    },
    {
        "good-luck": 9,
        "content-cn": "越出远门越能提高幸运值的日子",
        "content-jp": "遠くに行くほど、幸運になります"
    },
    {
        "good-luck": 9,
        "content-cn": "善解人意的一天，道出鼓励的话语吧"
    },
    {
        "good-luck": 9,
        "content-cn": "寄全身于好奇心，世界将更加宽阔"
    },
    {
        "good-luck": 8,
        "content-cn": "今天听到的甜蜜言语不信为○"
    },
    {
        "good-luck": 8,
        "content-cn": "拥有独处的时间会使内心满足"
    },
    {
        "good-luck": 8,
        "content-cn": "能够通过新的体验深造自己的一天"
    },
    {
        "good-luck": 7,
        "content-cn": "与人接触可丰富内心，亲切待人是幸运之钥"
    },
    {
        "good-luck": 7,
        "content-cn": "越是凭直觉大胆行动越能加速进展的日子"
    },
    {
        "good-luck": 7,
        "content-cn": "可能会从亲近的亲戚那里得知条件不错的事！"
    },
    {
        "good-luck": 6,
        "content-cn": "匀出自由的时间，便能充实地度过"
    },
    {
        "good-luck": 20,
        "content-cn": "万事顺利的一天 麻利工作即是吉"
    },
    {
        "good-luck": 21,
        "content-cn": "变得更加坚强，女性朋友是幸运的关鍵"
    },
    {
        "good-luck": 9,
        "content-cn": "看东西的眼光很准的一天 SALE也◎"
    },
    {
        "good-luck": 9,
        "content-cn": "原本的魅力闪耀的一天 珍惜喜欢的事物"
    },
    {
        "good-luck": 9,
        "content-cn": "去获取时效性高的情报吧！"
    },
    {
        "good-luck": 8,
        "content-cn": "对手上的锅也能感觉到有意义",
        "content-jp": "手持ちの鍋から何かを感じることができます"
    },
    {
        "good-luck": 8,
        "content-cn": "求知欲比平时更高！",
        "content-jp": "好奇心はいつもより高いです！"
    },
    {
        "good-luck": -7,
        "content-cn": "做惯了的工作会发生低级错误！？"
    },
    {
        "good-luck": 7,
        "content-cn": "和亲近之人心灵相通 传达感激之情吧"
    },
    {
        "good-luck": 7,
        "content-cn": "同情心加深的一天 坦率道出温柔话语吧"
    },
    {
        "good-luck": 7,
        "content-cn": "可以期待心跳的一天 慢慢进展便可"
    },
    {
        "good-luck": -8,
        "content-cn": "自我主张要适可而止，步调保持一致"
    },
    {
        "good-luck": 10,
        "content-cn": "有意义的工作，将会是成长的关键"
    },
    {
        "good-luck": 21,
        "content-cn": "被异性喜爱的一天 相信自己的魅力"
    },
    {
        "good-luck": 23,
        "content-cn": "即使想法被驳回也不要气馁！"
    },
    {
        "good-luck": 21,
        "content-cn": "会有重要的邂逅，或许能发展为长期交往"
    },
    {
        "good-luck": 9,
        "content-cn": "为了提高自己技能的自我投资"
    },
    {
        "good-luck": 8,
        "content-cn": "或许能从亲人那里听到好消息"
    },
    {
        "good-luck": 24,
        "content-cn": "钱包里留最低限度的钱就好"
    },
    {
        "good-luck": 25,
        "content-cn": "好像会对学习有兴趣，马上学习吧"
    },
    {
        "good-luck": 7,
        "content-cn": "喜爱的饮料可以帮自己高度集中注意力"
    },
    {
        "good-luck": 7,
        "content-cn": "实用物品只用同种品牌会带来好运"
    },
    {
        "good-luck": 7,
        "content-cn": "感觉能做到的话，请务必坚持下来！"
    },
    {
        "good-luck": -7,
        "content-cn": "不去着急的话，就能一帆风顺的一天"
    },
    {
        "good-luck": 10,
        "content-cn": "被幽默感眷顾的一天，尽情的发言吧！"
    },
    {
        "good-luck": 26,
        "content-cn": "身为领导者，连身边人的幸运都能提高的一天"
    },
    {
        "good-luck": 9,
        "content-cn": "早上日程表的确认能够带来好运"
    },
    {
        "good-luck": 9,
        "content-cn": "被人期待的一天，整理总结的任务应该也能胜任"
    },
    {
        "good-luck": 8,
        "content-cn": "下定决心向人撒娇就能进展顺利的一天"
    },
    {
        "good-luck": 8,
        "content-cn": "拥有判断力，感觉可以买到满意的东西"
    },
    {
        "good-luck": 8,
        "content-cn": "热衷于眼前的事物可以使心情放松"
    },
    {
        "good-luck": 7,
        "content-cn": "不去着急的话就能一帆风顺的一天"
    },
    {
        "good-luck": 7,
        "content-cn": "今天的工作一个人做进展会更顺利"
    },
    {
        "good-luck": 7,
        "content-cn": "听点轻快的音乐就能进展顺利的一天"
    },
    {
        "good-luck": -7,
        "content-cn": "凭借新的体验，得以加深自己的一天"
    },
    {
        "good-luck": 23,
        "content-cn": "事业运顺畅！积极地向周围的人搭话吧"
    },
    {
        "good-luck": 6,
        "content-cn": "在时尚上花钱"
    },
    {
        "good-luck": 9,
        "content-cn": "即使准备工作很困难，也不要放过机会"
    },
    {
        "good-luck": 9,
        "content-cn": "临时收入用来犒劳自己吧"
    },
    {
        "good-luck": 9,
        "content-cn": "今天就尽可能收集情报吧！"
    },
    {
        "good-luck": 8,
        "content-cn": "能接近理想的一天，积极行动吧！"
    },
    {
        "good-luck": 8,
        "content-cn": "是该考虑如何妥善安排的时候！"
    },
    {
        "good-luck": 24,
        "content-cn": "培养眼见也让财运UP吧！"
    },
    {
        "good-luck": 21,
        "content-cn": "爱情方面有进展的机会，表现得坦率一些"
    },
    {
        "good-luck": 7,
        "content-cn": "可能会抽到不错的签！？"
    },
    {
        "good-luck": 7,
        "content-cn": "重在保持自我的日子，兴趣优先"
    },
    {
        "good-luck": -7,
        "content-cn": "有在意的东西的话，便去获取它"
    },
    {
        "good-luck": 10,
        "content-cn": "新的开始，会熠熠生辉的幸运日☆"
    },
    {
        "good-luck": 9,
        "content-cn": "运气和实力会成为对你的期待"
    },
    {
        "good-luck": 9,
        "content-cn": "定好今后的目标，每天都要为之努力"
    },
    {
        "good-luck": 27,
        "content-cn": "人运旺盛！扩展人脉吧"
    },
    {
        "good-luck": 9,
        "content-cn": "知觉敏锐的一天，随好奇心而动"
    },
    {
        "good-luck": 8,
        "content-cn": "能走近他人内心的一天，温柔将会闪耀"
    },
    {
        "good-luck": 8,
        "content-cn": "目前请仅专注于提升实力"
    },
    {
        "good-luck": 8,
        "content-cn": "对教养的关注也可能会提高"
    },
    {
        "good-luck": 7,
        "content-cn": "高难度的工作也能高效推进"
    },
    {
        "good-luck": 7,
        "content-cn": "膳食选择质量优于数量，心情也会随之变好！"
    },
    {
        "good-luck": 6,
        "content-cn": "买东西要慎重，不要吝啬交际费用"
    },
    {
        "good-luck": -7,
        "content-cn": "心情变化剧烈的一天 凭借深呼吸冷静下来"
    },
    {
        "good-luck": 10,
        "content-cn": "在提升技能与教养上花钱的话◎"
    },
    {
        "good-luck": 27,
        "content-cn": "能够拓展人际关系的一天，谨慎地与人交往吧"
    },
    {
        "good-luck": 9,
        "content-cn": "跨越眼下的困境将会得到很好的成长"
    },
    {
        "good-luck": 9,
        "content-cn": "努力的话可以获得与之相应的成果的一天"
    },
    {
        "good-luck": 9,
        "content-cn": "努力完成工作，自然能够磨炼自己的能力"
    },
    {
        "good-luck": 8,
        "content-cn": "今天带最低限度的钱出门吧"
    },
    {
        "good-luck": 8,
        "content-cn": "积蓄至今的努力，将会成为你突破波澜万丈的运气！"
    },
    {
        "good-luck": 6,
        "content-cn": "不要焦急不要慌张，用心细致地完成工作吧！"
    },
    {
        "good-luck": 7,
        "content-cn": "培养与人之间的羁绊，多进行愉快的谈话吧"
    },
    {
        "good-luck": 5,
        "content-cn": "用心做出冷静的判断则吉"
    },
    {
        "good-luck": 7,
        "content-cn": "勒紧钱包的话将会找到更加重要的东西"
    },
    {
        "good-luck": -7,
        "content-cn": "是被人关注的一天，要把和谐关系放在第一位"
    },
    {
        "good-luck": 10,
        "content-cn": "万事顺利的一天！"
    },
    {
        "good-luck": 9,
        "content-cn": "相信自己的能力坚持到最后吧！"
    },
    {
        "good-luck": 9,
        "content-cn": "有可能会被采用意见并且得到称赞哦"
    },
    {
        "good-luck": 9,
        "content-cn": "用团队合作来提升工作质量吧！"
    },
    {
        "good-luck": 9,
        "content-cn": "机遇无处不在，试着扩大一下活动范围吧"
    },
    {
        "good-luck": 6,
        "content-cn": "天上可不会掉馅饼喔"
    },
    {
        "good-luck": 6,
        "content-cn": "钱包少放钱，刷卡也避免"
    },
    {
        "good-luck": 8,
        "content-cn": "或许会产生想要提高知识与修养的念头"
    },
    {
        "good-luck": 7,
        "content-cn": "不拘泥于小节心情才会变得舒畅"
    },
    {
        "good-luck": 7,
        "content-cn": "是时候为了取得资格而开始学习了"
    },
    {
        "good-luck": 21,
        "content-cn": "或许会有爱情方面的收获 能让人心意相通的一天"
    },
    {
        "good-luck": 10,
        "content-cn": "不要忘记谦虚的初心"
    },
    {
        "good-luck": 9,
        "content-cn": "多与他人接触充实内心 亲切待人是好运的关键"
    },
    {
        "good-luck": 26,
        "content-cn": "出乎想象开心的一天，把笑容分享给周围吧"
    },
    {
        "good-luck": 9,
        "content-cn": "或许可以在SNS上领悟到什么人生启发！？"
    },
    {
        "good-luck": 9,
        "content-cn": "是受人所托的一天，最好果断的行动"
    },
    {
        "good-luck": 8,
        "content-cn": "内心冷静的一天，不慌不忙的度过吧",
        "content-jp": "心の平穏な一日、静かに過ごしましょう"
    },
    {
        "good-luck": 24,
        "content-cn": "文钱不落虚空，财运UP！"
    },
    {
        "good-luck": 23,
        "content-cn": "可能会有机会得到能增长自己见识的副业"
    },
    {
        "good-luck": 7,
        "content-cn": "心跳加速万分期待的日子，对进展要从容不迫"
    },
    {
        "good-luck": 5,
        "content-cn": "珍惜私人时间明天才会更有活力"
    },
    {
        "good-luck": 26,
        "content-cn": "自己和别人被承认的一天，要深深地点头认可"
    },
    {
        "good-luck": -7,
        "content-cn": "既然得到他人劝告就要虚心改正"
    }
];

const luck_name = [
    [10,  {"name-jp": "大吉", "name-cn": "大吉"}],
    [9,   {"name-jp": "中吉", "name-cn": "中吉"}],
    [8,   {"name-jp": "小吉", "name-cn": "小吉"}],
    [7,   {"name-jp": "吉", "name-cn": "吉"}],
    [6,   {"name-jp": "半吉", "name-cn": "半吉"}],
    [5,   {"name-jp": "末吉", "name-cn": "末吉"}],
    [4,   {"name-jp": "末小吉", "name-cn": "末小吉"}],
    [-6,  {"name-jp": "末凶", "name-cn": "末凶"}],
    [-7,  {"name-jp": "半凶", "name-cn": "半凶"}],
    [-8,  {"name-jp": "小凶", "name-cn": "小凶"}],
    [-9,  {"name-jp": "凶", "name-cn": "凶"}],
    [-10, {"name-jp": "大凶", "name-cn": "大凶"}],
    [20,  {"name-jp": "総合運", "name-cn": "综合运"}],
    [21,  {"name-jp": "恋愛運", "name-cn": "恋爱运"}],
    [22,  {"name-jp": "結婚運", "name-cn": "结婚运"}],
    [23,  {"name-jp": "仕事運", "name-cn": "工作运"}],
    [24,  {"name-jp": "金運", "name-cn": "金钱运"}],
    [25,  {"name-jp": "勉強運", "name-cn": "学习运"}],
    [26,  {"name-jp": "全体運", "name-cn": "全体运"}],
    [27,  {"name-jp": "関係運", "name-cn": "关系运"}],
];

const force_line = new Set([' ', '，', '、']);
const textSpacing = 4, lineSpacing = 10;

function text_rect(text, arrWidth, maxWidth) {
    let textWidth = 0, textHeight = 0, lineHeight = 0, lineWidth = 0;
    for(let i=0; i<arrWidth.length; ++i) {
        const itemWidth = arrWidth[i] + textSpacing;
        if(force_line.has(text[i]) || textWidth + itemWidth > maxWidth) {
            lineWidth = Math.max(lineWidth, textWidth);
            if(textHeight > 0) {
                textHeight += lineSpacing;
            }
            textHeight += lineHeight;
            textWidth = 0;
            continue;
        }
        textWidth += itemWidth;
        lineHeight = Math.max(lineHeight, arrWidth[i]);
    }
    if(textWidth > 0) {
        lineWidth = Math.max(lineWidth, textWidth);
        textHeight += lineHeight;
    }
    return [textHeight, lineWidth]
}

CanvasRenderingContext2D.prototype.fillTextVertical = function (text, x, y, maxWidth) {
    let context = this;
    let canvas = context.canvas;

    let arrText = text.split('');
    let arrWidth = arrText.map(function (letter) {
        return context.measureText(letter).width;
    });
    const rect = text_rect(text, arrWidth, maxWidth);
    let lineWidth = Math.max.apply(Math, arrWidth);

    const align = context.textAlign;
    const baseline = context.textBaseline;

    x += rect[0] / 2;
    y -= rect[1] / 2;
    const maxY = y + rect[1], y_start = y;

    context.textAlign = 'center';
    context.textBaseline = 'middle';

    arrText.forEach(function (letter, index) {
        if (letter.charCodeAt(0) <= 256) {
            context.translate(x, y);
            context.rotate(90 * Math.PI / 180);
            context.translate(-x, -y);
        } else if (index > 0 && text.charCodeAt(index - 1) < 256) {
            y = y + arrWidth[index - 1] / 2;
        }
        context.fillText(letter, x, y);
        context.setTransform(1, 0, 0, 1, 0, 0);
        y = y + arrWidth[index] + textSpacing;
        if(force_line.has(letter) || y > maxY) {
            x -= (lineWidth + lineSpacing);
            y = y_start;
        }
    });
    context.textAlign = align;
    context.textBaseline = baseline;
};

function guid() {
    return 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        let r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8);
        return v.toString(16);
    });
}

let x = 806;

function rand() {
    x = Math.floor((1103515245 * x + 12345) / 65536) % 32768;
    return x;
}

function show_omikuji() {
    $('#p-content').load('omikuji.html', function() {
        //Check whether we have flag in cookie.
        const id_name = 'hitona-id';
        if(window.localStorage.getItem(id_name) === null) {
            //Create a uuid for it.
            window.localStorage.setItem(id_name, guid());
        }
        //Based on the uuid and date, calculate the id.
        const user_id = window.localStorage.getItem(id_name);
        //Set the user id as seed.
        x = parseInt(Number("0x"+user_id.substr(0, 8)), 10);
        //Loop for date times.
        const td = new Date();
        $('#omikuji-title').text(today_luck());
        $('#omikuji-date').text(td.getFullYear() + '/' + (td.getMonth() + 1) + '/' + td.getDate() + ' ' + day_of_the_week(td.getDay()));
        let td_day = td.getDay();
        if(td_day === 0) {
            td_day = 7;
        }
        let loop_time = Math.floor(((td.getMonth() + 1) * 100 + td.getDate() + td.getFullYear()) / td_day);
        while(loop_time > 0) { rand(); --loop_time;}

        const omi = omikuji_text[x % omikuji_text.length];
        const language_key = 'content-' + lan_my_lan;
        let target_text = '';
        if(language_key in omi) {
            target_text = omi[language_key];
        } else {
            target_text = omi['content-cn'];
        }
        //Find the title.
        let omi_title = '';
        for(let i=0; i<luck_name.length; ++i) {
            if(luck_name[i][0] === omi['good-luck']) {
                const name_set = luck_name[i][1];
                const target_name = 'name-' + lan_my_lan;
                if(name_set[target_name] === undefined) {
                    omi_title = name_set['name-jp'];
                } else {
                    omi_title = name_set[target_name];
                }
                break;
            }
        }

        let canvas = document.getElementById('omikuji-img');
        canvas.width = 480;
        canvas.height = 480;
        let canvas_2d = canvas.getContext('2d');
        var img = new Image();
        img.onload = function() {
            canvas_2d.drawImage(img, 0, 0);
            canvas_2d.fillStyle = "white";
            canvas_2d.font = "40px omikuji-title";
            canvas_2d.textAlign = "center";
            canvas_2d.fillText(omi_title, 141, 114, 480);

            canvas_2d.fillStyle = "black";
            canvas_2d.font = "22px serif-sans";
            canvas_2d.textAlign = "left";
            canvas_2d.fillTextVertical(target_text, 135, 285, 284);
        }
        rand();
        img.src = "asserts/omikuji/assert"+(x % 3)+".png";
    });
}